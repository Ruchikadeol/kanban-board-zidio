{"version":3,"sources":["../../src/services/auth.service.ts"],"sourcesContent":["import { hash, compare } from 'bcrypt';\nimport { sign } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { CreateUserDto } from '@dtos/users.dto';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, TokenData } from '@interfaces/auth.interface';\nimport { User } from '@interfaces/users.interface';\nimport UserModel from '@models/users.model';\nimport { isEmpty } from '@utils/util';\nimport { v4 as uuidv4 } from 'uuid';\n\nclass AuthService {\n  public users = UserModel;\n\n  public async signup(userData: CreateUserDto): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, 'UserData is empty');\n\n    const findUser = await this.users.findOne({ where: { username: userData.username } });\n    if (findUser) throw new HttpException(409, `This username already exists`);\n\n    const hashedPassword = await hash(userData.password, 10);\n    const createUserData = await this.users.create({ ...userData, id: uuidv4(), password: hashedPassword });\n\n    createUserData.password = undefined;\n    return createUserData;\n  }\n\n  public async login(userData: CreateUserDto): Promise<{ tokenData: TokenData; findUser: User }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'UserData is empty');\n\n    const findUser = await this.users.findOne({ where: { username: userData.username } });\n    if (!findUser) throw new HttpException(404, `This username ${userData.username} was not found`);\n\n    const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\n    if (!isPasswordMatching) throw new HttpException(409, 'Password is not matching');\n\n    const tokenData = this.createToken(findUser);\n    findUser.password = undefined;\n    return { findUser, tokenData };\n  }\n\n  public async logout(userId: string): Promise<User> {\n    if (isEmpty(userId)) throw new HttpException(400, 'User Id is empty');\n\n    const findUser = await this.users.findByPk(userId);\n    if (!findUser) throw new HttpException(404, `User not found`);\n\n    return findUser;\n  }\n\n  public createToken(user: User): TokenData {\n    const dataStoredInToken: DataStoredInToken = { userId: user.id };\n    const secretKey: string = SECRET_KEY;\n    const expiresIn: number = 60 * 60 * 24 * 1000;\n\n    return { expiresIn, token: sign(dataStoredInToken, secretKey, { expiresIn }) };\n  }\n}\n\nexport default AuthService;\n"],"names":["AuthService","signup","userData","isEmpty","HttpException","findUser","users","findOne","where","username","hashedPassword","hash","password","createUserData","create","id","uuidv4","undefined","login","isPasswordMatching","compare","tokenData","createToken","logout","userId","findByPk","user","dataStoredInToken","secretKey","SECRET_KEY","expiresIn","token","sign","UserModel"],"mappings":";;;;+BA2DA;;;eAAA;;;wBA3D8B;8BACT;wBACM;+BAEG;mEAGR;sBACE;sBACK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE7B,IAAA,AAAMA,cAAN,MAAMA;IAGJ,MAAaC,OAAOC,QAAuB,EAAiB;QAC1D,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK;QAEpD,MAAMC,WAAW,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,OAAO;gBAAEC,UAAUP,SAASO,QAAQ;YAAC;QAAE;QACnF,IAAIJ,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,4BAA4B,CAAC;QAEzE,MAAMM,iBAAiB,MAAMC,IAAAA,YAAI,EAACT,SAASU,QAAQ,EAAE;QACrD,MAAMC,iBAAiB,MAAM,IAAI,CAACP,KAAK,CAACQ,MAAM,CAAC,wCAAKZ;YAAUa,IAAIC,IAAAA,QAAM;YAAIJ,UAAUF;;QAEtFG,eAAeD,QAAQ,GAAGK;QAC1B,OAAOJ;IACT;IAEA,MAAaK,MAAMhB,QAAuB,EAAqD;QAC7F,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK;QAEpD,MAAMC,WAAW,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,OAAO;gBAAEC,UAAUP,SAASO,QAAQ;YAAC;QAAE;QACnF,IAAI,CAACJ,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,cAAc,EAAEF,SAASO,QAAQ,CAAC,cAAc,CAAC;QAE9F,MAAMU,qBAA8B,MAAMC,IAAAA,eAAO,EAAClB,SAASU,QAAQ,EAAEP,SAASO,QAAQ;QACtF,IAAI,CAACO,oBAAoB,MAAM,IAAIf,4BAAa,CAAC,KAAK;QAEtD,MAAMiB,YAAY,IAAI,CAACC,WAAW,CAACjB;QACnCA,SAASO,QAAQ,GAAGK;QACpB,OAAO;YAAEZ;YAAUgB;QAAU;IAC/B;IAEA,MAAaE,OAAOC,MAAc,EAAiB;QACjD,IAAIrB,IAAAA,aAAO,EAACqB,SAAS,MAAM,IAAIpB,4BAAa,CAAC,KAAK;QAElD,MAAMC,WAAW,MAAM,IAAI,CAACC,KAAK,CAACmB,QAAQ,CAACD;QAC3C,IAAI,CAACnB,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,cAAc,CAAC;QAE5D,OAAOC;IACT;IAEOiB,YAAYI,IAAU,EAAa;QACxC,MAAMC,oBAAuC;YAAEH,QAAQE,KAAKX,EAAE;QAAC;QAC/D,MAAMa,YAAoBC,kBAAU;QACpC,MAAMC,YAAoB,KAAK,KAAK,KAAK;QAEzC,OAAO;YAAEA;YAAWC,OAAOC,IAAAA,kBAAI,EAACL,mBAAmBC,WAAW;gBAAEE;YAAU;QAAG;IAC/E;;QA5CA,uBAAOxB,SAAQ2B,mBAAS;;AA6C1B;MAEA,WAAejC"}